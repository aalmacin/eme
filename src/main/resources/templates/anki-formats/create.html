<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Anki Card Format - EME</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">

    <style>
        .format-builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }
        .card-item {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.25rem;
            background: var(--bulma-scheme-main-bis);
            border: 1px solid var(--bulma-border);
            border-radius: var(--radius-sm);
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        .card-item:hover { background: var(--bulma-background); }
        .card-item.dragging { opacity: 0.5; }
        .drop-zone {
            min-height: 100px;
            padding: 0.75rem;
            border: 2px dashed var(--bulma-border);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }
        .drop-zone.drag-over { background: #e7f3ff; border-color: #3273dc; }
        .drop-zone-empty { text-align: center; color: #555555; padding: 1.5rem; }
        .card-item-controls { display: flex; gap: 0.5rem; align-items: center; font-size: 0.75rem; }
        .btn-remove { cursor: pointer; color: #f14668; font-size: 1rem; }
        @media screen and (max-width: 768px) {
            .format-builder { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar is-primary" role="navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold is-size-5" th:href="@{/}">
                    <span class="icon mr-2"><i class="fas fa-language"></i></span>
                    <span>EME</span>
                </a>
            </div>
            <div class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item" th:href="@{/}">Home</a>
                    <a class="navbar-item is-active" th:href="@{/anki-formats}">Anki Formats</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="eme-main">
        <div class="container">
            <a th:href="@{/anki-formats}" class="button is-light is-small mb-4">
                <span class="icon"><i class="fas fa-arrow-left"></i></span>
                <span>Back to Formats</span>
            </a>

            <h1 class="title">Create Anki Card Format</h1>

            <div class="box mb-4">
                <div class="field">
                    <label class="label">Format Name</label>
                    <div class="control">
                        <input type="text" class="input" id="formatName" placeholder="e.g., Basic Front/Back">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Description (Optional)</label>
                    <div class="control">
                        <textarea class="textarea" id="formatDescription" rows="2" placeholder="Describe this format..."></textarea>
                    </div>
                </div>
            </div>

            <div class="format-builder">
                <div class="box">
                    <h2 class="title is-5">Available Card Items</h2>
                    <p class="has-text-grey is-size-7 mb-3">Drag items to Front or Back card</p>
                    <div id="availableItems"></div>
                </div>

                <div class="box">
                    <div class="columns">
                        <div class="column">
                            <h2 class="title is-5">Front Card</h2>
                            <div id="frontCardItems" class="drop-zone"></div>
                        </div>
                        <div class="column">
                            <h2 class="title is-5">Back Card</h2>
                            <div id="backCardItems" class="drop-zone"></div>
                        </div>
                    </div>

                    <div class="buttons mt-4">
                        <button class="button is-primary" onclick="saveFormat()">
                            <span class="icon"><i class="fas fa-check"></i></span>
                            <span>Create Format</span>
                        </button>
                        <a th:href="@{/anki-formats}" class="button is-light">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const cardTypes = /*[[${cardTypes}]]*/ [];
        let draggedElement = null;
        let draggedFromZone = null;

        function initializeAvailableItems() {
            const container = document.getElementById('availableItems');
            cardTypes.forEach(type => {
                container.appendChild(createCardItem(type, false));
            });
        }

        function createCardItem(cardType, isToggled, fromZone = 'available') {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.draggable = true;
            div.dataset.cardType = cardType;
            div.dataset.isToggled = isToggled;
            div.dataset.fromZone = fromZone;

            const content = document.createElement('span');
            content.textContent = cardType.replace(/_/g, ' ').replace('MNEMONIC SENTENCE', 'MNEMONIC');

            const controls = document.createElement('div');
            controls.className = 'card-item-controls';

            if (fromZone !== 'available') {
                const toggleLabel = document.createElement('label');
                toggleLabel.className = 'checkbox';
                toggleLabel.innerHTML = '<input type="checkbox" ' + (isToggled ? 'checked' : '') + '> Collapsible';
                toggleLabel.querySelector('input').addEventListener('change', (e) => {
                    div.dataset.isToggled = e.target.checked;
                });
                controls.appendChild(toggleLabel);

                const removeBtn = document.createElement('span');
                removeBtn.className = 'btn-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => { div.remove(); updateDropZones(); };
                controls.appendChild(removeBtn);
            }

            div.appendChild(content);
            div.appendChild(controls);
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            return div;
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedFromZone = e.target.parentElement.id;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) { e.target.classList.remove('dragging'); }

        function handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone && draggedElement) {
                dropZone.classList.remove('drag-over');
                const cardType = draggedElement.dataset.cardType;
                const isToggled = draggedElement.dataset.isToggled === 'true';

                if (draggedFromZone === 'availableItems') {
                    dropZone.appendChild(createCardItem(cardType, false, dropZone.id));
                } else {
                    dropZone.appendChild(createCardItem(cardType, isToggled, dropZone.id));
                    draggedElement.remove();
                }
                updateDropZones();
            }
        }

        function updateDropZones() {
            ['frontCardItems', 'backCardItems'].forEach(zoneId => {
                const zone = document.getElementById(zoneId);
                const emptyMsg = zone.querySelector('.drop-zone-empty');
                if (zone.querySelectorAll('.card-item').length === 0) {
                    if (!emptyMsg) zone.innerHTML = '<div class="drop-zone-empty">Drag items here</div>';
                } else if (emptyMsg) emptyMsg.remove();
            });
        }

        function saveFormat() {
            const name = document.getElementById('formatName').value.trim();
            const description = document.getElementById('formatDescription').value.trim();

            if (!name) { alert('Please enter a format name'); return; }

            const frontItems = getCardItemsFromZone('frontCardItems');
            const backItems = getCardItemsFromZone('backCardItems');

            if (frontItems.length === 0 || backItems.length === 0) {
                alert('Both front and back card must have at least one item');
                return;
            }

            fetch('/anki-formats/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name, description,
                    format: { name, frontCardItems: frontItems, backCardItems: backItems }
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) { alert('Format created!'); window.location.href = '/anki-formats'; }
                else alert('Error: ' + data.error);
            })
            .catch(err => alert('Error: ' + err));
        }

        function getCardItemsFromZone(zoneId) {
            const items = [];
            let order = 0;
            document.getElementById(zoneId).querySelectorAll('.card-item').forEach(item => {
                items.push({ cardType: item.dataset.cardType, order: order++, isToggled: item.dataset.isToggled === 'true' });
            });
            return items;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAvailableItems();
            ['frontCardItems', 'backCardItems'].forEach(zoneId => {
                const zone = document.getElementById(zoneId);
                zone.addEventListener('dragover', e => { e.preventDefault(); });
                zone.addEventListener('dragenter', e => { if (e.target.classList.contains('drop-zone')) e.target.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => { if (e.target.classList.contains('drop-zone')) e.target.classList.remove('drag-over'); });
                zone.addEventListener('drop', handleDrop);
            });
            updateDropZones();
        });
        /*]]>*/
    </script>
</body>
</html>
