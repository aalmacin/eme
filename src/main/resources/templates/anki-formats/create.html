<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Anki Card Format - Eme</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.1.3/css/bootstrap.min.css}">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .nav-links {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .nav-links a {
            margin-right: 15px;
            text-decoration: none;
            color: #007bff;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .format-builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        .available-items, .card-builder {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .available-items {
            max-height: 80vh;
            overflow-y: auto;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }

        .card-item {
            padding: 6px 8px;
            margin-bottom: 4px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .card-item:hover {
            background: #e9ecef;
        }

        .card-item.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 100px;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .drop-zone.drag-over {
            background: #e7f3ff;
            border-color: #007bff;
        }

        .drop-zone-empty {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .card-item-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }

        .toggle-checkbox {
            margin-right: 5px;
        }

        .card-sides {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card-side {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }

        .btn-remove {
            cursor: pointer;
            color: #dc3545;
            font-size: 16px;
            line-height: 1;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="nav-links">
        <a th:href="@{/anki-formats}">Back to Formats</a>
        <a th:href="@{/}">Home</a>
    </div>

    <h1>Create Anki Card Format</h1>

    <div class="mb-3">
        <label for="formatName" class="form-label">Format Name</label>
        <input type="text" class="form-control" id="formatName" placeholder="e.g., Basic Front/Back">
    </div>

    <div class="mb-3">
        <label for="formatDescription" class="form-label">Description (Optional)</label>
        <textarea class="form-control" id="formatDescription" rows="2" placeholder="Describe this format..."></textarea>
    </div>

    <div class="format-builder">
        <div class="available-items">
            <div class="section-title">Available Card Items</div>
            <p class="text-muted small">Drag items to Front or Back card</p>
            <div id="availableItems"></div>
        </div>

        <div class="card-builder">
            <div class="card-sides">
                <div class="card-side">
                    <div class="section-title">Front Card</div>
                    <div id="frontCardItems" class="drop-zone"></div>
                </div>

                <div class="card-side">
                    <div class="section-title">Back Card</div>
                    <div id="backCardItems" class="drop-zone"></div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveFormat()">Create Format</button>
            <button class="btn btn-secondary" onclick="window.location.href='/anki-formats'">Cancel</button>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script th:src="@{/webjars/bootstrap/5.1.3/js/bootstrap.bundle.min.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const cardTypes = /*[[${cardTypes}]]*/ [];

    let draggedElement = null;
    let draggedFromZone = null;

    // Initialize available items
    function initializeAvailableItems() {
        const container = document.getElementById('availableItems');
        cardTypes.forEach(type => {
            const item = createCardItem(type, false);
            container.appendChild(item);
        });
    }

    function createCardItem(cardType, isToggled, fromZone = 'available') {
        const div = document.createElement('div');
        div.className = 'card-item';
        div.draggable = true;
        div.dataset.cardType = cardType;
        div.dataset.isToggled = isToggled;
        div.dataset.fromZone = fromZone;

        const label = formatCardTypeName(cardType);

        const content = document.createElement('span');
        content.textContent = label;

        const controls = document.createElement('div');
        controls.className = 'card-item-controls';

        if (fromZone !== 'available') {
            // Add toggle checkbox
            const toggleLabel = document.createElement('label');
            toggleLabel.innerHTML = '<input type="checkbox" class="toggle-checkbox" ' + (isToggled ? 'checked' : '') + '> Collapsible';
            toggleLabel.querySelector('input').addEventListener('change', (e) => {
                div.dataset.isToggled = e.target.checked;
            });
            controls.appendChild(toggleLabel);

            // Add remove button
            const removeBtn = document.createElement('span');
            removeBtn.className = 'btn-remove';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = () => removeItem(div);
            controls.appendChild(removeBtn);
        }

        div.appendChild(content);
        div.appendChild(controls);

        // Drag events
        div.addEventListener('dragstart', handleDragStart);
        div.addEventListener('dragend', handleDragEnd);

        return div;
    }

    function formatCardTypeName(cardType) {
        return cardType.replace(/_/g, ' ').replace('MNEMONIC SENTENCE', 'MNEMONIC');
    }

    function handleDragStart(e) {
        draggedElement = e.target;
        draggedFromZone = e.target.parentElement.id;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        if (e.target.classList.contains('drop-zone')) {
            e.target.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        if (e.target.classList.contains('drop-zone')) {
            e.target.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        e.preventDefault();

        const dropZone = e.target.closest('.drop-zone');
        if (dropZone && draggedElement) {
            dropZone.classList.remove('drag-over');

            const cardType = draggedElement.dataset.cardType;
            const isToggled = draggedElement.dataset.isToggled === 'true';

            // If dragging from available items, create new item
            if (draggedFromZone === 'availableItems') {
                const newItem = createCardItem(cardType, false, dropZone.id);
                dropZone.appendChild(newItem);
            } else {
                // Moving between zones
                const newItem = createCardItem(cardType, isToggled, dropZone.id);
                dropZone.appendChild(newItem);
                draggedElement.remove();
            }

            updateDropZones();
        }

        return false;
    }

    function removeItem(item) {
        item.remove();
        updateDropZones();
    }

    function updateDropZones() {
        ['frontCardItems', 'backCardItems'].forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            if (zone.children.length === 0) {
                zone.innerHTML = '<div class="drop-zone-empty">Drag items here</div>';
            } else {
                const emptyMsg = zone.querySelector('.drop-zone-empty');
                if (emptyMsg) emptyMsg.remove();
            }
        });
    }

    function saveFormat() {
        const name = document.getElementById('formatName').value.trim();
        const description = document.getElementById('formatDescription').value.trim();

        if (!name) {
            alert('Please enter a format name');
            return;
        }

        const frontItems = getCardItemsFromZone('frontCardItems');
        const backItems = getCardItemsFromZone('backCardItems');

        if (frontItems.length === 0 || backItems.length === 0) {
            alert('Both front and back card must have at least one item');
            return;
        }

        const formatData = {
            name: name,
            description: description,
            format: {
                name: name,
                frontCardItems: frontItems,
                backCardItems: backItems
            }
        };

        fetch('/anki-formats/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formatData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Format created successfully!');
                window.location.href = '/anki-formats';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error creating format: ' + error);
        });
    }

    function getCardItemsFromZone(zoneId) {
        const zone = document.getElementById(zoneId);
        const items = [];
        let order = 0;

        zone.querySelectorAll('.card-item').forEach(item => {
            items.push({
                cardType: item.dataset.cardType,
                order: order++,
                isToggled: item.dataset.isToggled === 'true'
            });
        });

        return items;
    }

    // Setup drop zones
    function setupDropZones() {
        ['frontCardItems', 'backCardItems'].forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragenter', handleDragEnter);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initializeAvailableItems();
        setupDropZones();
        updateDropZones();
    });
    /*]]>*/
</script>
</body>
</html>
