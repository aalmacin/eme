<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Session Details - Eme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-links a {
            margin-right: 15px;
            text-decoration: none;
            color: #007bff;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: bold;
            width: 200px;
            color: #495057;
        }
        .info-value {
            flex: 1;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-primary {
            background-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-in-progress {
            background-color: #17a2b8;
            color: #fff;
        }
        .status-completed {
            background-color: #28a745;
            color: #fff;
        }
        .status-failed {
            background-color: #dc3545;
            color: #fff;
        }
        .data-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .data-section pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }
        .collapsible-header {
            cursor: pointer;
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 0;
            user-select: none;
        }
        .collapsible-header:hover {
            background: #dee2e6;
        }
        .collapsible-header .arrow {
            float: right;
            transition: transform 0.3s ease;
        }
        .collapsible-header:not(.collapsed) .arrow {
            transform: rotate(180deg);
        }
        .collapse-content {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 0 4px 4px;
            margin-top: 5px;
        }
        .word-item {
            padding: 8px;
            background: white;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 16px;
        }
        .process-status-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #6c757d;
        }
        .process-status-card.success {
            border-left-color: #28a745;
        }
        .process-status-card.partial {
            border-left-color: #ffc107;
        }
        .process-status-card.failure {
            border-left-color: #dc3545;
        }
        .process-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .error-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .error-list li {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        .word-detail {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .word-detail-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .process-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .process-item.success {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }
        .process-item.failed {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }
        .process-name {
            font-weight: 500;
        }
        .process-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .image-prompt-override {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .reused-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            margin-left: 10px;
        }
        .new-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            margin-left: 10px;
        }
        .word-select-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 12px;
            vertical-align: middle;
        }
        .word-detail.selected {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }
        .selection-toolbar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #dee2e6;
        }
        .selection-count {
            font-weight: bold;
            color: #007bff;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Translation Session Details</h1>
        <div class="nav-links">
            <a href="/sessions">‚Üê Back to Sessions</a>
            <a href="/">Home</a>
            <a href="/translations">üìö Translations</a>
            <a href="/sentences">üìù Sentences</a>
            <a href="/character-guide">üé≠ Character Guide</a>
        </div>
    </div>

    <div class="info-card">
        <h2>Session Information</h2>
        <div class="info-row">
            <div class="info-label">Session ID:</div>
            <div class="info-value" th:text="${translationSession.id}"></div>
        </div>
        <div class="info-row">
            <div class="info-label">Word:</div>
            <div class="info-value"><strong th:text="${translationSession.word}"></strong></div>
        </div>
        <div class="info-row">
            <div class="info-label">Source Language:</div>
            <div class="info-value" th:text="${translationSession.sourceLanguage}"></div>
        </div>
        <div class="info-row">
            <div class="info-label">Target Language:</div>
            <div class="info-value" th:text="${translationSession.targetLanguage}"></div>
        </div>
        <div class="info-row">
            <div class="info-label">Status:</div>
            <div class="info-value">
                <span th:class="'status-badge status-' + ${#strings.toLowerCase(translationSession.status)}"
                      th:text="${translationSession.status}"></span>
            </div>
        </div>
        <div class="info-row">
            <div class="info-label">Image Generation:</div>
            <div class="info-value" th:text="${translationSession.imageGenerationEnabled ? 'Enabled' : 'Disabled'}"></div>
        </div>
        <div class="info-row">
            <div class="info-label">Audio Generation:</div>
            <div class="info-value" th:text="${translationSession.audioGenerationEnabled ? 'Enabled' : 'Disabled'}"></div>
        </div>
        <div class="info-row">
            <div class="info-label">Created:</div>
            <div class="info-value" th:text="${#temporals.format(translationSession.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></div>
        </div>
        <div class="info-row" th:if="${translationSession.completedAt != null}">
            <div class="info-label">Completed:</div>
            <div class="info-value" th:text="${#temporals.format(translationSession.completedAt, 'yyyy-MM-dd HH:mm:ss')}"></div>
        </div>

        <!-- Action Buttons -->
        <div th:if="${sessionData.containsKey('original_request')}" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
            <form th:action="@{/sessions/{id}/retry(id=${translationSession.id})}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-warning">üîÑ Retry Entire Session</button>
            </form>
            <button type="button" class="btn btn-success" onclick="generateWithPreset()">‚öôÔ∏è Generate with Same Preset</button>
        </div>
    </div>

    <!-- Words Section with Detailed Status -->
    <div class="info-card" th:if="${sessionData.containsKey('words') && !sessionData.get('words').isEmpty()}">
        <div class="collapsible-header" data-bs-toggle="collapse" data-bs-target="#words-content" aria-expanded="true" aria-controls="words-content">
            <h2 style="margin: 0; display: inline-block;">
                <span th:text="${sessionData.containsKey('total_words') ? sessionData.get('total_words') : sessionData.get('words').size()}"></span> Words
            </h2>
            <span th:if="${sessionData.containsKey('dedup_stats')}" style="font-size: 14px; margin-left: 15px; color: #6c757d;">
                <span th:if="${sessionData.get('dedup_stats').get('reused_count') > 0}"
                      th:text="'‚ôªÔ∏è ' + ${sessionData.get('dedup_stats').get('reused_count')} + ' reused'"
                      style="margin-right: 10px;"></span>
                <span th:if="${sessionData.get('dedup_stats').get('new_count') > 0}"
                      th:text="'‚ú® ' + ${sessionData.get('dedup_stats').get('new_count')} + ' new'"></span>
            </span>
            <span class="arrow">‚ñº</span>
        </div>
        <div id="words-content" class="collapse show">
            <div class="collapse-content">
            <!-- Selection Toolbar -->
            <div class="selection-toolbar" id="selectionToolbar" style="display: none;">
                <div>
                    <span class="selection-count" id="selectionCount">0 selected</span>
                </div>
                <div>
                    <button onclick="selectAllWords()" class="btn btn-sm" style="background: #6c757d; margin-right: 5px;">Select All</button>
                    <button onclick="deselectAllWords()" class="btn btn-sm" style="background: #6c757d; margin-right: 10px;">Deselect All</button>
                    <button onclick="showBatchRegenerateModal()" class="btn btn-warning" id="batchRegenerateBtn" style="display: none;">
                        üîÑ Regenerate Selected (<span id="batchRegenerateCount">0</span>)
                    </button>
                </div>
            </div>
            <div th:each="wordData, iterStat : ${sessionData.get('words')}" class="word-detail">
                <div class="word-detail-header">
                    <input type="checkbox"
                           class="word-select-checkbox"
                           th:if="${wordData.containsKey('word_id')}"
                           th:data-word-id="${wordData.get('word_id')}"
                           th:data-source-word="${wordData.get('source_word')}"
                           onchange="handleWordCheckboxChange(this)">
                    <span th:text="${wordData.get('source_word')}"></span>
                    <span th:if="${wordData.containsKey('source_transliteration')}"
                          th:text="' (' + ${wordData.get('source_transliteration')} + ')'"
                          style="font-size: 16px; color: #0056b3; font-weight: 600; font-style: italic; margin-left: 8px;"></span>
                    <span th:if="${wordData.containsKey('translations')}"
                          th:text="' ‚Üí ' + ${wordData.get('translations')}"
                          style="font-size: 14px; color: #6c757d; font-weight: normal;"></span>
                    <span th:if="${wordData.containsKey('reused') && wordData.get('reused') == true}"
                          class="reused-badge">‚ôªÔ∏è Reused from previous session</span>
                    <span th:if="${wordData.containsKey('reused') && wordData.get('reused') == false}"
                          class="new-badge">‚ú® Newly generated</span>

                    <!-- Word Actions -->
                    <span th:if="${wordData.containsKey('word_id')}" style="float: right;">
                        <a th:href="@{/words/{id}(id=${wordData.get('word_id')})}"
                           class="btn btn-sm btn-outline-primary"
                           style="margin-left: 10px;">
                            üìñ View Details
                        </a>
                        <button type="button"
                                th:data-word-id="${wordData.get('word_id')}"
                                th:data-source-word="${wordData.get('source_word')}"
                                onclick="showRegenerateModal(this.dataset.wordId, this.dataset.sourceWord)"
                                class="btn btn-sm btn-outline-warning"
                                style="margin-left: 5px;">
                            üîÑ Regenerate Image
                        </button>
                    </span>
                </div>

                <!-- Translation Status -->
                <div th:if="${wordData.containsKey('translation_status')}"
                     th:class="'process-item ' + (${wordData.get('translation_status')} == 'success' ? 'success' : 'failed')">
                    <div>
                        <span class="process-name">Translation:</span>
                        <span th:if="${wordData.get('translation_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('translation_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                        <small th:if="${wordData.containsKey('translation_error')}"
                               th:text="' - ' + ${wordData.get('translation_error')}"
                               style="color: #721c24; display: block; margin-top: 4px;"></small>
                    </div>
                    <div class="process-actions" th:if="${wordData.get('translation_status')} == 'failed'">
                        <form th:action="@{/sessions/{id}/retry-word-translation(id=${translationSession.id})}" method="post" style="display: inline;">
                            <input type="hidden" name="wordIndex" th:value="${iterStat.index}"/>
                            <button type="submit" class="btn btn-danger btn-sm">Retry</button>
                        </form>
                    </div>
                </div>

                <!-- Audio Status -->
                <div th:if="${wordData.containsKey('source_audio_file')}" class="process-item success">
                    <div>
                        <span class="process-name">Source Audio:</span>
                        <span style="color: #28a745;">‚úì Generated</span>
                        <code th:text="${wordData.get('source_audio_file')}" style="font-size: 11px; margin-left: 8px;"></code>
                    </div>
                </div>

                <!-- Sentence Status -->
                <div th:if="${wordData.containsKey('sentence_status')}"
                     th:class="'process-item ' + (${wordData.get('sentence_status')} == 'success' ? 'success' : 'failed')">
                    <div>
                        <span class="process-name">Sentence:</span>
                        <span th:if="${wordData.get('sentence_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('sentence_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                        <small th:if="${wordData.containsKey('sentence_error')}"
                               th:text="' - ' + ${wordData.get('sentence_error')}"
                               style="color: #721c24; display: block; margin-top: 4px;"></small>
                    </div>
                    <div class="process-actions" th:if="${wordData.get('sentence_status')} == 'failed'">
                        <form th:action="@{/sessions/{id}/retry-word-sentence(id=${translationSession.id})}" method="post" style="display: inline;">
                            <input type="hidden" name="wordIndex" th:value="${iterStat.index}"/>
                            <button type="submit" class="btn btn-danger btn-sm">Retry</button>
                        </form>
                    </div>
                </div>

                <!-- Image Status -->
                <div th:if="${wordData.containsKey('image_status')}"
                     th:class="'process-item ' + (${wordData.get('image_status')} == 'success' ? 'success' : 'failed')">
                    <div style="flex: 1;">
                        <span class="process-name">Image:</span>
                        <span th:if="${wordData.get('image_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('image_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                        <small th:if="${wordData.containsKey('image_error')}"
                               th:text="' - ' + ${wordData.get('image_error')}"
                               style="color: #721c24; display: block; margin-top: 4px;"></small>

                        <!-- Display image thumbnail if successful -->
                        <div th:if="${wordData.get('image_status') == 'success' and wordData.containsKey('image_file')}"
                             style="margin-top: 12px; display: flex; align-items: flex-start; gap: 15px;">
                            <img th:src="@{'/generated_images/' + ${wordData.get('image_file')}}"
                                 alt="Word image"
                                 style="max-width: 200px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"/>
                            <div th:if="${wordData.containsKey('image_prompt')}" style="margin-left: 15px;">
                                <small style="color: #6c757d;">Prompt:</small>
                                <pre th:text="${wordData.get('image_prompt')}" style="font-size: 11px; background: #f1f3f5; padding: 8px; border-radius: 4px; margin-top: 4px; max-width: 400px; white-space: pre-wrap;"></pre>
                            </div>
                        </div>

                        <!-- Show prompt even if no image yet -->
                        <div th:if="${wordData.get('image_status') != 'success' and wordData.containsKey('image_prompt')}" style="margin-top: 8px;">
                            <small style="color: #6c757d;">Prompt:</small>
                            <pre th:text="${wordData.get('image_prompt')}" style="font-size: 11px; background: #f1f3f5; padding: 8px; border-radius: 4px; margin-top: 4px;"></pre>
                        </div>
                    </div>
                    <div class="process-actions" th:if="${wordData.get('image_status')} == 'failed'">
                        <form th:action="@{/sessions/{id}/retry-word-image(id=${translationSession.id})}" method="post" style="display: inline;">
                            <input type="hidden" name="wordIndex" th:value="${iterStat.index}"/>
                            <div>
                                <input type="text" name="imagePromptOverride"
                                       th:placeholder="'Override prompt (optional)'"
                                       class="image-prompt-override"/>
                                <button type="submit" class="btn btn-danger btn-sm" style="margin-top: 8px; margin-left: 0;">Retry Image</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Character Guide Information -->
                <div th:if="${wordData.containsKey('character_name')}" class="process-item" style="background: #f8f9fa; border-left: 3px solid #6c757d;">
                    <div style="flex: 1;">
                        <span class="process-name">Character Used:</span>
                        <strong th:text="${wordData.get('character_name')}"></strong>
                        <span th:if="${wordData.containsKey('character_context') && !wordData.get('character_context').isEmpty()}"
                              th:text="' (' + ${wordData.get('character_context')} + ')'"
                              style="color: #6c757d; font-size: 12px;"></span>

                        <div style="margin-top: 8px;">
                            <small style="color: #6c757d;">
                                Start sound: <code th:text="${wordData.get('character_start_sound')}" style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;"></code>
                            </small>
                        </div>

                        <!-- Show status badge -->
                        <div style="margin-top: 8px;">
                            <span th:if="${wordData.get('character_in_guide') == true}"
                                  style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ‚úì In Character Guide
                            </span>
                            <span th:if="${wordData.get('character_in_guide') == false}"
                                  style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ‚ö† Not in Character Guide
                            </span>
                        </div>
                    </div>

                    <!-- Add to Character Guide button -->
                    <div class="process-actions" th:if="${wordData.get('character_in_guide') == false}">
                        <button type="button"
                                th:data-language="${translationSession.sourceLanguage}"
                                th:data-start-sound="${wordData.get('character_start_sound')}"
                                th:data-character-name="${wordData.get('character_name')}"
                                th:data-character-context="${wordData.get('character_context')}"
                                onclick="showAddCharacterModal(this.dataset)"
                                class="btn btn-success btn-sm">
                            ‚ûï Add to Character Guide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Information for In-Progress Sessions -->
    <div class="info-card" th:if="${translationSession.status.name() == 'IN_PROGRESS'}">
        <h2>‚è≥ Processing In Progress</h2>

        <!-- Show progress bar if we have processed_words info -->
        <div th:if="${sessionData.containsKey('processed_words') && sessionData.containsKey('total_words')}" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-weight: bold;">Progress:</span>
                <span th:text="${sessionData.get('processed_words')} + ' / ' + ${sessionData.get('total_words')} + ' words processed'"></span>
            </div>
            <div style="background: #e9ecef; border-radius: 8px; height: 24px; overflow: hidden;">
                <div th:style="'width: ' + ${(sessionData.get('processed_words') * 100.0 / sessionData.get('total_words'))} + '%; background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; border-radius: 8px; transition: width 0.3s ease;'"></div>
            </div>
            <div th:if="${sessionData.containsKey('last_update')}" style="margin-top: 8px; font-size: 12px; color: #6c757d;">
                Last updated: <span th:text="${sessionData.get('last_update')}"></span>
            </div>
        </div>

        <!-- Show current word progress if available -->
        <div th:if="${sessionData.containsKey('words') && !sessionData.get('words').isEmpty()}" style="margin-bottom: 20px;">
            <h3 style="font-size: 18px; margin-bottom: 15px;">Current Progress by Word:</h3>
            <div th:each="wordData, iterStat : ${sessionData.get('words')}" class="word-detail" style="opacity: 0.95;">
                <div class="word-detail-header">
                    <span th:text="${wordData.get('source_word')}"></span>
                    <span th:if="${wordData.containsKey('source_transliteration')}"
                          th:text="' (' + ${wordData.get('source_transliteration')} + ')'"
                          style="font-size: 16px; color: #0056b3; font-weight: 600; font-style: italic; margin-left: 8px;"></span>
                    <span th:if="${wordData.containsKey('translations')}"
                          th:text="' ‚Üí ' + ${wordData.get('translations')}"
                          style="font-size: 14px; color: #6c757d; font-weight: normal;"></span>
                    <span style="float: right; color: #28a745; font-size: 14px;">‚úì Processed</span>
                </div>

                <!-- Translation Status -->
                <div th:if="${wordData.containsKey('translation_status')}"
                     th:class="'process-item ' + (${wordData.get('translation_status')} == 'success' ? 'success' : 'failed')">
                    <div>
                        <span class="process-name">Translation:</span>
                        <span th:if="${wordData.get('translation_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('translation_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                    </div>
                </div>

                <!-- Audio Status -->
                <div th:if="${wordData.containsKey('source_audio_file')}" class="process-item success">
                    <div>
                        <span class="process-name">Source Audio:</span>
                        <span style="color: #28a745;">‚úì Queued</span>
                    </div>
                </div>

                <!-- Sentence Status -->
                <div th:if="${wordData.containsKey('sentence_status')}"
                     th:class="'process-item ' + (${wordData.get('sentence_status')} == 'success' ? 'success' : 'failed')">
                    <div>
                        <span class="process-name">Sentence:</span>
                        <span th:if="${wordData.get('sentence_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('sentence_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                    </div>
                </div>

                <!-- Image Status -->
                <div th:if="${wordData.containsKey('image_status')}"
                     th:class="'process-item ' + (${wordData.get('image_status')} == 'success' ? 'success' : 'failed')">
                    <div style="flex: 1;">
                        <span class="process-name">Image:</span>
                        <span th:if="${wordData.get('image_status')} == 'success'" style="color: #28a745;">‚úì Success</span>
                        <span th:if="${wordData.get('image_status')} == 'failed'" style="color: #dc3545;">‚úó Failed</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Show planned steps if no progress data yet -->
        <div th:if="${!sessionData.containsKey('words') || sessionData.get('words').isEmpty()}">
            <p>This session is starting. The following steps will be completed:</p>
            <ul style="list-style: none; padding-left: 0;">
                <li style="padding: 8px 0;">üìù Translation of words</li>
                <li th:if="${translationSession.audioGenerationEnabled}" style="padding: 8px 0;">üîä Audio generation</li>
                <li th:if="${translationSession.imageGenerationEnabled}" style="padding: 8px 0;">üñºÔ∏è Image generation with mnemonics</li>
                <li th:if="${translationSession.sentenceGenerationEnabled}" style="padding: 8px 0;">üìÑ Sentence generation</li>
                <li style="padding: 8px 0;">üì¶ ZIP file creation</li>
            </ul>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>‚ö†Ô∏è Note:</strong> This session is actively being processed. Refresh the page to see the latest progress.
        </div>
        <button onclick="window.location.reload()" class="btn" style="margin-top: 15px;">üîÑ Refresh to Check Progress</button>

        <!-- Auto-refresh script -->
        <script>
            // Auto-refresh every 5 seconds while processing
            setTimeout(function() {
                if (window.location.href.indexOf('sessions/') > -1) {
                    window.location.reload();
                }
            }, 5000);
        </script>
    </div>

    <!-- Process Status Section -->
    <div class="info-card" th:if="${sessionData.containsKey('process_summary')}">
        <h2>Process Status</h2>

        <!-- Translation Status -->
        <div th:with="translationErrors=${sessionData.get('process_summary').get('translation_errors')}"
             th:if="${translationSession.imageGenerationEnabled || translationSession.audioGenerationEnabled}"
             th:classappend="${translationErrors.isEmpty() ? 'success' : 'failure'}"
             class="process-status-card">
            <div class="process-header">
                Translation:
                <span th:if="${translationErrors.isEmpty()}" style="color: #28a745;">‚úì Success</span>
                <span th:if="${!translationErrors.isEmpty()}" style="color: #dc3545;">‚úó Failed</span>
            </div>
            <ul th:if="${!translationErrors.isEmpty()}" class="error-list">
                <li th:each="error : ${translationErrors}" th:text="${error}"></li>
            </ul>
        </div>

        <!-- Audio Status -->
        <div th:with="audioErrors=${sessionData.get('process_summary').get('audio_errors')},
                      audioSuccess=${sessionData.get('process_summary').get('audio_success_count')},
                      audioFailure=${sessionData.get('process_summary').get('audio_failure_count')}"
             th:if="${translationSession.audioGenerationEnabled}"
             th:classappend="${audioErrors.isEmpty() ? 'success' : (audioSuccess > 0 ? 'partial' : 'failure')}"
             class="process-status-card">
            <div class="process-header">
                Audio Generation:
                <span th:if="${audioErrors.isEmpty()}" style="color: #28a745;">‚úì All Success (<span th:text="${audioSuccess}"></span> files)</span>
                <span th:if="${!audioErrors.isEmpty() && audioSuccess > 0}" style="color: #ffc107;">‚ö† Partial Success (<span th:text="${audioSuccess}"></span> success, <span th:text="${audioFailure}"></span> failed)</span>
                <span th:if="${!audioErrors.isEmpty() && audioSuccess == 0}" style="color: #dc3545;">‚úó All Failed</span>
            </div>
            <ul th:if="${!audioErrors.isEmpty()}" class="error-list">
                <li th:each="error : ${audioErrors}" th:text="${error}"></li>
            </ul>
        </div>

        <!-- Image Status -->
        <div th:with="imageErrors=${sessionData.get('process_summary').get('image_errors')}"
             th:if="${translationSession.imageGenerationEnabled}"
             th:classappend="${imageErrors.isEmpty() ? 'success' : 'failure'}"
             class="process-status-card">
            <div class="process-header">
                Image Generation:
                <span th:if="${imageErrors.isEmpty()}" style="color: #28a745;">‚úì Success</span>
                <span th:if="${!imageErrors.isEmpty()}" style="color: #dc3545;">‚úó Failed</span>
            </div>
            <ul th:if="${!imageErrors.isEmpty()}" class="error-list">
                <li th:each="error : ${imageErrors}" th:text="${error}"></li>
            </ul>
        </div>

        <!-- Sentence Status -->
        <div th:with="sentenceErrors=${sessionData.get('process_summary').get('sentence_errors')}"
             th:if="${translationSession.sentenceGenerationEnabled}"
             th:classappend="${sentenceErrors.isEmpty() ? 'success' : 'failure'}"
             class="process-status-card">
            <div class="process-header">
                Sentence Generation:
                <span th:if="${sentenceErrors.isEmpty()}" style="color: #28a745;">‚úì Success</span>
                <span th:if="${!sentenceErrors.isEmpty()}" style="color: #dc3545;">‚úó Failed</span>
            </div>
            <ul th:if="${!sentenceErrors.isEmpty()}" class="error-list">
                <li th:each="error : ${sentenceErrors}" th:text="${error}"></li>
            </ul>
        </div>

        <!-- Retry Buttons -->
        <div th:if="${sessionData.get('process_summary').get('has_errors')}" style="margin-top: 20px;">
            <form th:action="@{/sessions/{id}/retry(id=${translationSession.id})}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-warning">Retry Failed Processes</button>
            </form>
        </div>
    </div>

    <div class="info-card" th:if="${translationSession.status.name() == 'COMPLETED'}">
        <h2>Generated Assets</h2>
        <div class="info-row" th:if="${sessionData.containsKey('mnemonic_keyword')}">
            <div class="info-label">Mnemonic Keyword:</div>
            <div class="info-value"><strong th:text="${sessionData.get('mnemonic_keyword')}"></strong></div>
        </div>
        <div class="info-row" th:if="${sessionData.containsKey('mnemonic_sentence')}">
            <div class="info-label">Mnemonic Sentence:</div>
            <div class="info-value" th:text="${sessionData.get('mnemonic_sentence')}"></div>
        </div>
        <div class="info-row" th:if="${sessionData.containsKey('image_file')}">
            <div class="info-label">Image File:</div>
            <div class="info-value"><code th:text="${sessionData.get('image_file')}"></code></div>
        </div>
        <div class="info-row" th:if="${sessionData.containsKey('local_path')}">
            <div class="info-label">Local Path:</div>
            <div class="info-value"><code th:text="${sessionData.get('local_path')}"></code></div>
        </div>
        <div class="info-row" th:if="${sessionData.containsKey('gcs_url')}">
            <div class="info-label">GCS Backup:</div>
            <div class="info-value"><code th:text="${sessionData.get('gcs_url')}"></code></div>
        </div>
        <div class="info-row" th:if="${sessionData.containsKey('credit_cost')}">
            <div class="info-label">Image Credit Cost:</div>
            <div class="info-value"><strong th:text="${sessionData.get('credit_cost')} + ' credits'"></strong></div>
        </div>

        <div style="margin-top: 20px;">
            <a th:href="@{/sessions/{id}/download(id=${translationSession.id})}" class="btn btn-success">Download Assets (ZIP)</a>

            <!-- Anki Card Creation Button -->
            <div th:if="${translationSession.ankiEnabled}" style="display: inline-block; margin-left: 10px;">
                <form th:action="@{/sessions/{id}/create-anki-cards(id=${translationSession.id})}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-primary">Create Anki Cards</button>
                </form>
            </div>
        </div>

        <div class="data-section" th:if="${sessionData.containsKey('image_prompt')}">
            <h4>Image Prompt Used:</h4>
            <pre th:text="${sessionData.get('image_prompt')}"></pre>
        </div>
    </div>

    <div class="info-card" th:if="${translationSession.status.name() == 'FAILED'}">
        <h2>Error Information</h2>
        <div class="error-message" th:if="${sessionData.containsKey('error')}">
            <strong>Error:</strong>
            <p th:text="${sessionData.get('error')}"></p>
            <small th:if="${sessionData.containsKey('errorTime')}" th:text="'Error occurred at: ' + ${sessionData.get('errorTime')}"></small>
        </div>
    </div>

    <!-- Session Data Debug Info (for empty sessions) -->
    <div class="info-card" th:if="${!sessionData.containsKey('words') && translationSession.status.name() == 'COMPLETED'}">
        <h2>Session Completed (Legacy Format)</h2>
        <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeaa7;">
            This session was completed using an older format. Detailed word-by-word information is not available.
        </p>
        <div th:if="${!sessionData.isEmpty()}">
            <h3>Available Data:</h3>
            <div class="data-section">
                <pre th:text="${sessionData}"></pre>
            </div>
        </div>
    </div>

    <!-- Pending Status -->
    <div class="info-card" th:if="${translationSession.status.name() == 'PENDING'}">
        <h2>‚è∏Ô∏è Session Pending</h2>
        <p>This session is pending and will start processing soon.</p>
        <button onclick="window.location.reload()" class="btn">Refresh Page</button>
    </div>

    <!-- Full Session Data (JSON) - Collapsible for debugging -->
    <div class="info-card" th:if="${!sessionData.isEmpty()}">
        <div class="collapsible-header collapsed" data-bs-toggle="collapse" data-bs-target="#session-data-content" aria-expanded="false" aria-controls="session-data-content">
            <h2 style="margin: 0; display: inline-block;">Full Session Data (JSON)</h2>
            <span style="font-size: 14px; margin-left: 15px; color: #6c757d;">For debugging purposes</span>
            <span class="arrow">‚ñº</span>
        </div>
        <div id="session-data-content" class="collapse">
            <div class="collapse-content">
                <div class="data-section">
                    <pre th:text="${sessionData}"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Regenerate Image Modal -->
    <div id="regenerateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0;">Regenerate Image for <span id="modalWordTitle"></span></h3>

            <!-- Provider Selection -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Image Provider:</label>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="imageProvider" value="LEONARDO" checked style="margin-right: 6px;">
                        Leonardo AI
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="imageProvider" value="OPENAI" style="margin-right: 6px;">
                        GPT Image 1
                    </label>
                </div>
            </div>

            <!-- Use Same Prompt Checkbox -->
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="useSamePromptCheckbox" style="margin-right: 8px;">
                    Use same prompt (reuse existing prompt instead of generating new one)
                </label>
            </div>

            <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">Custom prompt (optional - leave blank to auto-generate new prompt):</p>
            <textarea id="regeneratePromptTextarea"
                      placeholder="Enter a custom image prompt or leave blank to auto-generate..."
                      style="width: 100%; min-height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div id="regenerateStatus" style="color: #6c757d; font-size: 14px;"></div>
                <div>
                    <button onclick="closeRegenerateModal()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
                    <button onclick="regenerateWordImage()" class="btn btn-warning" id="regenerateBtn">üîÑ Regenerate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Regenerate Image Modal -->
    <div id="batchRegenerateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 900px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0;">Batch Regenerate Images (<span id="batchModalCount">0</span> words)</h3>

            <!-- Global Settings -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #007bff;">
                <h4 style="margin-top: 0; font-size: 16px;">Apply to All Words:</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: bold; margin-right: 10px;">Provider:</label>
                        <select id="globalProvider" onchange="applyProviderToAll()" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="">-- Don't change --</option>
                            <option value="LEONARDO">Leonardo AI</option>
                            <option value="OPENAI">GPT Image 1</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="globalUseSamePrompt" onchange="applyUseSamePromptToAll()" style="margin-right: 6px;">
                            Use same prompt for all
                        </label>
                    </div>
                    <div style="flex: 1;">
                        <button onclick="applyCustomPromptToAll()" class="btn btn-sm" style="background: #6c757d;">
                            Apply Custom Prompt to All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Word List -->
            <div id="batchWordList" style="max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Words will be dynamically added here -->
            </div>

            <!-- Progress Section -->
            <div id="batchProgress" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-top: 0; font-size: 16px;">Progress:</h4>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span id="batchProgressText">Processing...</span>
                        <span id="batchProgressNumbers">0 / 0</span>
                    </div>
                    <div style="background: #e9ecef; border-radius: 8px; height: 24px; overflow: hidden;">
                        <div id="batchProgressBar" style="width: 0%; background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; border-radius: 8px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                <div id="batchProgressDetails" style="max-height: 200px; overflow-y: auto; font-size: 14px;">
                    <!-- Progress details will be shown here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div id="batchStatus" style="color: #6c757d; font-size: 14px;"></div>
                <div>
                    <button onclick="closeBatchRegenerateModal()" class="btn btn-secondary" style="margin-right: 10px;" id="batchCancelBtn">Cancel</button>
                    <button onclick="startBatchRegeneration()" class="btn btn-warning" id="batchStartBtn">üîÑ Start Batch Regeneration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Character Guide Modal -->
    <div id="addCharacterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0;">Add Character to Guide</h3>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Language:</label>
                <input type="text" id="addCharLanguage" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Start Sound:</label>
                <input type="text" id="addCharStartSound" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #6c757d; display: block; margin-top: 4px;">The phonetic sound at the start of the word (e.g., "cha", "sh")</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Character Name:</label>
                <input type="text" id="addCharName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #6c757d; display: block; margin-top: 4px;">The character or person's name (e.g., "Charizard", "Shanks")</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Character Context:</label>
                <input type="text" id="addCharContext" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #6c757d; display: block; margin-top: 4px;">Where the character is from (e.g., "Pokemon", "One Piece")</small>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div id="addCharStatus" style="color: #6c757d; font-size: 14px;"></div>
                <div>
                    <button onclick="closeAddCharacterModal()" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
                    <button onclick="addCharacterToGuide()" class="btn btn-success" id="addCharBtn">‚ûï Add to Guide</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Batch Regeneration State
        let selectedWords = new Set();
        let batchRegenerationData = {};
        let batchInProgress = false;

        // Update selection UI
        function updateSelectionUI() {
            const count = selectedWords.size;
            const toolbar = document.getElementById('selectionToolbar');
            const countEl = document.getElementById('selectionCount');
            const batchBtn = document.getElementById('batchRegenerateBtn');
            const batchCountEl = document.getElementById('batchRegenerateCount');

            if (count > 0) {
                toolbar.style.display = 'flex';
                countEl.textContent = `${count} selected`;
                batchBtn.style.display = 'inline-block';
                batchCountEl.textContent = count;
            } else {
                toolbar.style.display = 'none';
            }
        }

        // Handle individual checkbox change
        function handleWordCheckboxChange(checkbox) {
            const wordId = checkbox.dataset.wordId;
            const wordDetail = checkbox.closest('.word-detail');

            if (checkbox.checked) {
                selectedWords.add(wordId);
                wordDetail.classList.add('selected');
            } else {
                selectedWords.delete(wordId);
                wordDetail.classList.remove('selected');
            }

            updateSelectionUI();
        }

        // Select all words
        function selectAllWords() {
            const checkboxes = document.querySelectorAll('.word-select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedWords.add(checkbox.dataset.wordId);
                checkbox.closest('.word-detail').classList.add('selected');
            });
            updateSelectionUI();
        }

        // Deselect all words
        function deselectAllWords() {
            const checkboxes = document.querySelectorAll('.word-select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.word-detail').classList.remove('selected');
            });
            selectedWords.clear();
            updateSelectionUI();
        }

        // Show batch regenerate modal
        function showBatchRegenerateModal() {
            if (selectedWords.size === 0) return;

            // Initialize regeneration data
            batchRegenerationData = {};
            selectedWords.forEach(wordId => {
                const checkbox = document.querySelector(`[data-word-id="${wordId}"]`);
                batchRegenerationData[wordId] = {
                    wordId: wordId,
                    sourceWord: checkbox.dataset.sourceWord,
                    provider: 'LEONARDO',
                    useSamePrompt: false,
                    customPrompt: '',
                    status: 'pending'
                };
            });

            // Populate modal
            populateBatchModal();

            // Show modal
            document.getElementById('batchRegenerateModal').style.display = 'block';
            document.getElementById('batchModalCount').textContent = selectedWords.size;

            // Reset progress
            document.getElementById('batchProgress').style.display = 'none';
            document.getElementById('batchStatus').textContent = '';
        }

        // Close batch regenerate modal
        function closeBatchRegenerateModal() {
            if (batchInProgress) {
                if (!confirm('Regeneration is in progress. Are you sure you want to close?')) {
                    return;
                }
            }
            document.getElementById('batchRegenerateModal').style.display = 'none';
        }

        // Populate batch modal with word list
        function populateBatchModal() {
            const wordListEl = document.getElementById('batchWordList');
            wordListEl.innerHTML = '';

            Object.values(batchRegenerationData).forEach((data, index) => {
                const wordDiv = document.createElement('div');
                wordDiv.style.cssText = 'background: white; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 8px;';
                wordDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">${index + 1}. ${data.sourceWord}</div>

                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: bold; margin-right: 10px;">Provider:</label>
                        <select class="word-provider" data-word-id="${data.wordId}" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="LEONARDO" selected>Leonardo AI</option>
                            <option value="OPENAI">GPT Image 1</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="word-use-same-prompt" data-word-id="${data.wordId}" style="margin-right: 6px;">
                            Use same prompt
                        </label>
                    </div>

                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Custom Prompt (optional):</label>
                        <textarea class="word-custom-prompt" data-word-id="${data.wordId}"
                                  placeholder="Leave blank to auto-generate..."
                                  style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;"></textarea>
                    </div>

                    <div class="word-status-${data.wordId}" style="margin-top: 10px; display: none; padding: 8px; border-radius: 4px; font-size: 13px;"></div>
                `;
                wordListEl.appendChild(wordDiv);

                // Add event listeners
                wordDiv.querySelector('.word-provider').addEventListener('change', (e) => {
                    batchRegenerationData[data.wordId].provider = e.target.value;
                });
                wordDiv.querySelector('.word-use-same-prompt').addEventListener('change', (e) => {
                    batchRegenerationData[data.wordId].useSamePrompt = e.target.checked;
                });
                wordDiv.querySelector('.word-custom-prompt').addEventListener('input', (e) => {
                    batchRegenerationData[data.wordId].customPrompt = e.target.value.trim();
                });
            });
        }

        // Apply provider to all
        function applyProviderToAll() {
            const provider = document.getElementById('globalProvider').value;
            if (!provider) return;

            document.querySelectorAll('.word-provider').forEach(select => {
                select.value = provider;
                const wordId = select.dataset.wordId;
                batchRegenerationData[wordId].provider = provider;
            });
        }

        // Apply use same prompt to all
        function applyUseSamePromptToAll() {
            const checked = document.getElementById('globalUseSamePrompt').checked;
            document.querySelectorAll('.word-use-same-prompt').forEach(checkbox => {
                checkbox.checked = checked;
                const wordId = checkbox.dataset.wordId;
                batchRegenerationData[wordId].useSamePrompt = checked;
            });
        }

        // Apply custom prompt to all
        function applyCustomPromptToAll() {
            const prompt = window.prompt('Enter custom prompt to apply to all words:');
            if (prompt === null) return;

            document.querySelectorAll('.word-custom-prompt').forEach(textarea => {
                textarea.value = prompt;
                const wordId = textarea.dataset.wordId;
                batchRegenerationData[wordId].customPrompt = prompt.trim();
            });
        }

        // Start batch regeneration
        async function startBatchRegeneration() {
            if (batchInProgress) return;

            batchInProgress = true;
            const words = Object.values(batchRegenerationData);
            const totalWords = words.length;
            let completedCount = 0;
            let successCount = 0;
            let failureCount = 0;

            // Show progress section
            document.getElementById('batchProgress').style.display = 'block';
            document.getElementById('batchStartBtn').disabled = true;
            document.getElementById('batchCancelBtn').disabled = true;

            // Initialize progress
            updateBatchProgress(completedCount, totalWords, 'Starting batch regeneration...');

            // Create promises for all words
            const promises = words.map(async (data) => {
                const wordId = data.wordId;
                const statusEl = document.querySelector(`.word-status-${wordId}`);

                // Show pending status
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = '‚è≥ Pending...';

                try {
                    // Prepare request body
                    const requestBody = {
                        provider: data.provider
                    };

                    if (data.customPrompt) {
                        requestBody.imagePrompt = data.customPrompt;
                    }

                    if (data.useSamePrompt) {
                        requestBody.useSamePrompt = true;
                    }

                    // Update status to processing
                    statusEl.style.background = '#cfe2ff';
                    statusEl.style.color = '#084298';
                    statusEl.textContent = 'üîÑ Regenerating...';

                    // Make API call
                    const response = await fetch(`/api/words/${wordId}/regenerate-image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Success
                        statusEl.style.background = '#d1e7dd';
                        statusEl.style.color = '#0f5132';
                        statusEl.textContent = '‚úì Success! Image regenerated.';
                        batchRegenerationData[wordId].status = 'success';
                        successCount++;
                    } else {
                        // API returned error
                        statusEl.style.background = '#f8d7da';
                        statusEl.style.color = '#842029';
                        statusEl.textContent = '‚úó Error: ' + (result.error || 'Unknown error');
                        batchRegenerationData[wordId].status = 'failed';
                        failureCount++;
                    }
                } catch (error) {
                    // Network or other error
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#842029';
                    statusEl.textContent = '‚úó Error: ' + error.message;
                    batchRegenerationData[wordId].status = 'failed';
                    failureCount++;
                }

                // Update progress
                completedCount++;
                updateBatchProgress(completedCount, totalWords, `Processing... (${completedCount}/${totalWords})`);
                addProgressDetail(data.sourceWord, batchRegenerationData[wordId].status);
            });

            // Wait for all promises to complete
            await Promise.all(promises);

            // All done
            batchInProgress = false;
            updateBatchProgress(totalWords, totalWords, 'Batch regeneration completed!');

            // Show summary
            const statusEl = document.getElementById('batchStatus');
            statusEl.style.color = successCount === totalWords ? '#28a745' : (failureCount === totalWords ? '#dc3545' : '#ffc107');
            statusEl.innerHTML = `<strong>Completed:</strong> ${successCount} succeeded, ${failureCount} failed`;

            // Update buttons
            document.getElementById('batchStartBtn').style.display = 'none';
            document.getElementById('batchCancelBtn').textContent = 'Close';
            document.getElementById('batchCancelBtn').disabled = false;

            // Auto-reload after delay if all succeeded
            if (failureCount === 0) {
                statusEl.innerHTML += ' <br><small>Page will reload in 3 seconds...</small>';
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }

        // Update batch progress bar
        function updateBatchProgress(completed, total, text) {
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('batchProgressBar').style.width = percentage + '%';
            document.getElementById('batchProgressText').textContent = text;
            document.getElementById('batchProgressNumbers').textContent = `${completed} / ${total}`;
        }

        // Add progress detail
        function addProgressDetail(sourceWord, status) {
            const detailsEl = document.getElementById('batchProgressDetails');
            const item = document.createElement('div');
            item.style.cssText = 'padding: 6px; margin-bottom: 4px; border-radius: 4px;';

            if (status === 'success') {
                item.style.background = '#d1e7dd';
                item.style.color = '#0f5132';
                item.textContent = `‚úì ${sourceWord} - Success`;
            } else {
                item.style.background = '#f8d7da';
                item.style.color = '#842029';
                item.textContent = `‚úó ${sourceWord} - Failed`;
            }

            detailsEl.appendChild(item);
            // Scroll to bottom
            detailsEl.scrollTop = detailsEl.scrollHeight;
        }

        let currentWordId = null;

        function showRegenerateModal(wordId, sourceWord) {
            currentWordId = wordId;
            document.getElementById('modalWordTitle').textContent = sourceWord;
            document.getElementById('regeneratePromptTextarea').value = '';
            document.getElementById('useSamePromptCheckbox').checked = false;
            document.querySelector('input[name="imageProvider"][value="LEONARDO"]').checked = true;
            document.getElementById('regenerateModal').style.display = 'flex';
            document.getElementById('regenerateStatus').textContent = '';
        }

        function closeRegenerateModal() {
            document.getElementById('regenerateModal').style.display = 'none';
            currentWordId = null;
        }

        async function regenerateWordImage() {
            if (!currentWordId) return;

            const customPrompt = document.getElementById('regeneratePromptTextarea').value.trim();
            const useSamePrompt = document.getElementById('useSamePromptCheckbox').checked;
            const provider = document.querySelector('input[name="imageProvider"]:checked').value;
            const statusEl = document.getElementById('regenerateStatus');
            const btnEl = document.getElementById('regenerateBtn');

            statusEl.textContent = 'Regenerating image...';
            statusEl.style.color = '#007bff';
            btnEl.disabled = true;

            try {
                const requestBody = {};

                // Add custom prompt if provided
                if (customPrompt) {
                    requestBody.imagePrompt = customPrompt;
                }

                // Add useSamePrompt flag
                if (useSamePrompt) {
                    requestBody.useSamePrompt = true;
                }

                // Add provider selection
                requestBody.provider = provider;

                const response = await fetch(`/api/words/${currentWordId}/regenerate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = 'Image regenerated! Reloading page...';
                    statusEl.style.color = '#28a745';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusEl.textContent = 'Error: ' + (result.error || 'Unknown error');
                    statusEl.style.color = '#dc3545';
                    btnEl.disabled = false;
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.style.color = '#dc3545';
                btnEl.disabled = false;
            }
        }

        // Close modal on background click
        document.getElementById('regenerateModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRegenerateModal();
            }
        });

        // Close batch modal on background click
        document.getElementById('batchRegenerateModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeBatchRegenerateModal();
            }
        });

        // Generate with same preset function
        function generateWithPreset() {
            // Store the session configuration in sessionStorage
            const presetConfig = {
                sourceLanguage: /*[[${translationSession.sourceLanguage}]]*/ 'hi',
                targetLanguage: /*[[${translationSession.targetLanguage}]]*/ 'en',
                enableSourceAudio: /*[[${translationSession.audioGenerationEnabled}]]*/ false,
                enableTargetAudio: /*[[${translationSession.audioGenerationEnabled}]]*/ false,
                enableTranslation: true,
                enableSentenceGeneration: /*[[${translationSession.sentenceGenerationEnabled}]]*/ false,
                enableImageGeneration: /*[[${translationSession.imageGenerationEnabled}]]*/ false,
                ankiEnabled: /*[[${translationSession.ankiEnabled}]]*/ false,
                ankiDeck: /*[[${translationSession.ankiDeck != null ? translationSession.ankiDeck : ''}]]*/ '',
                ankiFrontTemplate: /*[[${translationSession.ankiFrontTemplate != null ? translationSession.ankiFrontTemplate : ''}]]*/ '',
                ankiBackTemplate: /*[[${translationSession.ankiBackTemplate != null ? translationSession.ankiBackTemplate : ''}]]*/ ''
            };

            sessionStorage.setItem('loadPresetConfig', JSON.stringify(presetConfig));
            window.location.href = '/';
        }

        // Character Guide Modal Functions
        function showAddCharacterModal(dataset) {
            document.getElementById('addCharLanguage').value = dataset.language;
            document.getElementById('addCharStartSound').value = dataset.startSound;
            document.getElementById('addCharName').value = dataset.characterName;
            document.getElementById('addCharContext').value = dataset.characterContext || '';
            document.getElementById('addCharacterModal').style.display = 'flex';
            document.getElementById('addCharStatus').textContent = '';
        }

        function closeAddCharacterModal() {
            document.getElementById('addCharacterModal').style.display = 'none';
        }

        async function addCharacterToGuide() {
            const language = document.getElementById('addCharLanguage').value;
            const startSound = document.getElementById('addCharStartSound').value.trim();
            const characterName = document.getElementById('addCharName').value.trim();
            const characterContext = document.getElementById('addCharContext').value.trim();
            const statusEl = document.getElementById('addCharStatus');
            const btnEl = document.getElementById('addCharBtn');

            if (!startSound || !characterName) {
                statusEl.textContent = 'Please fill in required fields';
                statusEl.style.color = '#dc3545';
                return;
            }

            statusEl.textContent = 'Adding character to guide...';
            statusEl.style.color = '#007bff';
            btnEl.disabled = true;

            try {
                const response = await fetch('/character-guide/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        language: language,
                        startSound: startSound,
                        characterName: characterName,
                        characterContext: characterContext
                    })
                });

                if (response.ok) {
                    statusEl.textContent = 'Character added successfully!';
                    statusEl.style.color = '#28a745';
                    setTimeout(() => {
                        closeAddCharacterModal();
                        window.location.reload();
                    }, 1000);
                } else {
                    const text = await response.text();
                    statusEl.textContent = 'Error: ' + (text || 'Failed to add character');
                    statusEl.style.color = '#dc3545';
                    btnEl.disabled = false;
                }
            } catch (error) {
                console.error('Error adding character:', error);
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.style.color = '#dc3545';
                btnEl.disabled = false;
            }
        }

        // Close modal on background click
        document.getElementById('addCharacterModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddCharacterModal();
            }
        });
    </script>
</body>
</html>
